<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${user.name} + ' Profile'">Profile</title>
    <link href="/css/profile.css" rel="stylesheet">
    <script src="/js/profile.js"></script>
</head>
<body>

<!-- Include navbar -->
<div th:replace="navbar.html"></div>

<div class="settings-container">
    <!-- Afișăm numele utilizatorului și bio-ul -->
    <h2 th:text="${user.name} + ' Profile'"></h2>

    <!-- Data înregistrării utilizatorului -->
    <p><strong>Member since:</strong> <span th:text="${user.registrationDate.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd'))}"></span></p>

    <!-- Bio-ul utilizatorului -->
    <div id="bioSection" th:if="${user.bio != null && !user.bio.isEmpty()}">
        <p th:text="${user.bio}"></p>
        <!-- Buton de editare doar dacă utilizatorul vizualizat este cel conectat -->
        <button th:if="${isCurrentUser}" class="btn book-btn" onclick="editBio()">Edit Bio</button>
    </div>

    <!-- Mesaj și buton dacă bio-ul este gol -->
    <div id="bioSection" th:if="${user.bio == null || user.bio.isEmpty()}">
        <p>Bio-ul este gol.</p>
        <!-- Buton de adăugare doar dacă utilizatorul vizualizat este cel conectat -->
        <button th:if="${isCurrentUser}" class="btn book-btn" onclick="editBio()">Add Bio</button>
    </div>

    <!-- Formularul de editare bio -->
    <div id="bioForm" style="display: none;">
        <form th:action="@{/profile/updateBio}" method="post">
            <div class="form-group">
                <!-- Pre-populăm caseta de text cu bio-ul curent al utilizatorului -->
                <textarea id="bio" name="bio" rows="4" placeholder="Enter your bio here" required
                          th:text="${user.bio}"></textarea>
            </div>
            <div>
                <button type="submit" class="btn book-btn">Save Bio</button>
            </div>
        </form>
    </div>

    <br>
    <h2>Activity</h2>

    <!-- Button to toggle review visibility -->
    <button id="toggleReviews" data-section="Reviews" class="btn book-btn" onclick="toggleSection('reviewsSection', 'toggleReviews')">Show Reviews</button>

    <!-- Reviews Section -->
    <div id="reviewsSection" class="settings-section-content" style="display: none;">
        <h3>Your Reviews</h3>
        <ul th:if="${!#lists.isEmpty(userReviews)}" th:each="review : ${userReviews}">
            <li>
                <p><strong>Book:</strong> <span th:text="${review.book.title}"></span></p>
                <p><strong>Rating:</strong> <span th:text="${review.rating}"></span></p>
                <p><strong>Review:</strong> <span th:text="${review.reviewText}"></span></p>
                <p><strong>Date:</strong> <span th:text="${review.reviewDate}"></span></p>
                <!-- Buton stilizat pentru a merge la pagina cărții -->
                <a th:href="@{/reviews/view(bookId=${review.book.id})}" class="btn book-btn">View Book</a>
            </li>
        </ul>
        <p th:if="${#lists.isEmpty(userReviews)}">This user has not written any reviews yet.</p>
    </div>

    <!-- Button to toggle favorite books visibility -->
    <button id="toggleFavorites" data-section="Favorite Books" class="btn book-btn" onclick="toggleSection('favoritesSection', 'toggleFavorites')">Show Favorite Books</button>

    <!-- Favorite Books Section -->
    <div id="favoritesSection" class="settings-section-content" style="display: none;">
        <h3>Favorite Books</h3>
        <ul th:if="${!#lists.isEmpty(favoriteBooks)}" th:each="book : ${favoriteBooks}">
            <li>
                <p><strong>Title:</strong> <span th:text="${book.title}"></span></p>
                <!-- Buton stilizat pentru a merge la pagina cărții -->
                <a th:href="@{/reviews/view(bookId=${book.id})}" class="btn book-btn">View Book</a>
            </li>
        </ul>
        <p th:if="${#lists.isEmpty(favoriteBooks)}">This user has no favorite books.</p>
    </div>

    <!-- Schimbare Parolă -->
    <div class="settings-section" th:if="${isCurrentUser}">
        <br>
        <h2>Change Password</h2>
        <form th:action="@{/profile/changePassword}" method="post">
            <div class="form-group">
                <label for="oldPassword">Old Password:</label>
                <input type="password" id="oldPassword" name="oldPassword" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="newPassword" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            <button type="submit" class="btn book-btn">Change Password</button>
        </form>
    </div>

    <!-- Ștergere cont -->
    <div class="settings-section" th:if="${isCurrentUser}">
        <h2>Delete Account</h2>
        <!-- Adăugăm evenimentul `onclick` pe butonul de ștergere -->
        <form th:action="@{/profile/deleteAccount}" method="post">
            <button type="submit" class="btn book-btn delete-btn" onclick="confirmDeleteAccount(event)">Delete Account</button>
        </form>
    </div>

</div>

</body>
</html>
